<policies>
  <inbound>
    <base />
    <validate-jwt header-name="Authorization" require-scheme="Bearer">
      <openid-config url="{{AAD_OPENID_CONFIG}}" />
      <audiences><audience>{{AUDIENCE}}</audience></audiences>
    </validate-jwt>
    <set-variable name="callerAppId" value="@(jwt.ClaimsPrincipal.Current.FindFirstValue(&quot;appid&quot;) ?? jwt.ClaimsPrincipal.Current.FindFirstValue(&quot;azp&quot;))" />
    <check-header name="x-purpose" failed-check-httpcode="403" failed-check-error-message="Missing x-purpose header">
      <value>meeting_scheduling</value>
    </check-header>
    <choose>
      <when condition="@(new string[] { {{ALLOW_APPS_CALENDAR}} }.Contains((string)context.Variables[&quot;callerAppId&quot;]))">
      </when>
      <otherwise>
        <return-response>
          <set-status code="403" reason="Forbidden" />
          <set-body>@("{""allowed"":false,""reason"":""Caller not authorized for calendar_freebusy""}")</set-body>
        </return-response>
      </otherwise>
    </choose>
    <set-header name="X-Caller-AppId" exists-action="override"><value>@((string)context.Variables["callerAppId"])</value></set-header>
    <set-header name="X-Purpose" exists-action="override"><value>@((string)context.Request.Headers.GetValueOrDefault("x-purpose",""))</value></set-header>
  </inbound>
  <backend><base /></backend>
  <outbound><base /></outbound>
  <on-error><base /></on-error>
</policies>